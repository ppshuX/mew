{% extends "base.html" %}
{% load static %}

{% block title %}写动态{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'blog/css/blog_form.css' %}">
<div class="mew-form-bg">
    <div class="mew-form-card" style="max-width:900px;margin:0 auto;position:relative;">
        <a href="{% url 'blog_simple_create' %}" class="mew-switch-btn">切换到普通动态编辑</a>
        <div class="mew-form-title">
            博客编辑
        </div>
        <!-- 顶部区域 -->
        <div class="row mb-3 align-items-end">
            <div class="col-md-7">
                <label class="mew-form-label">博客标题 <span style="color: #ff6bcb;">*</span></label>
                <input type="text" name="blog_title" class="form-control" maxlength="100" placeholder="请输入博客标题"
                    required>
            </div>
            <div class="col-md-5">
                <label class="mew-form-label">关键词</label>
                <input type="text" name="blog_tags" class="form-control" placeholder="多个关键词用中文逗号分隔">
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-7"><small class="text-danger" id="title-tip">标题不能为空</small></div>
            <div class="col-md-5"><small class="text-muted">关键词用于分类或搜索</small></div>
        </div>
        <!-- 编辑器区域 -->
        <div class="mb-4" style="max-width:900px;margin:0 auto;">
            <div class="d-flex mb-2">
                <button type="button" id="tab-edit" class="btn btn-sm btn-primary me-2 active">编辑</button>
                <button type="button" id="tab-preview" class="btn btn-sm btn-outline-secondary">预览</button>
            </div>
            <div id="editor-area">
                <textarea name="blog_content" id="blog-content-textarea" class="form-control" rows="12"
                    required></textarea>
            </div>
            <div id="blog-preview-area"
                style="display:none;min-height:300px;border:1px solid #eee;background:#fafbfc;padding:18px 20px;border-radius:6px;">
            </div>
        </div>
        <!-- 辅助字段区 -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3 mb-md-0">
                <label class="mew-form-label">封面图</label>
                <input type="file" name="blog_cover" class="form-control" accept="image/*"
                    onchange="previewCover(this)">
                <img id="cover-preview" src="#" alt="封面预览"
                    style="display:none;max-width:100%;margin-top:8px;border-radius:4px;" />
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
                <label class="mew-form-label">类别</label>
                <select name="category" class="form-select form-select-sm">
                    <option value="all">全部类别</option>
                    {% for value, label in category_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="mew-form-label">摘要（可选）</label>
                <textarea name="blog_summary" class="form-control" rows="2" maxlength="200"
                    placeholder="一句话介绍你的博客"></textarea>
            </div>
        </div>
        <!-- 操作按钮区 -->
        <div class="d-flex justify-content-center mb-2">
            <button type="button" class="btn btn-outline-info me-3" id="blog-save-draft-btn">保存草稿</button>
            <button type="submit" class="btn btn-primary">发布博客</button>
        </div>
    </div>
</div>
<script src="{% static 'blog/js/blog_form.js' %}"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<script>
    // Tab切换逻辑
    const tabEdit = document.getElementById('tab-edit');
    const tabPreview = document.getElementById('tab-preview');
    const editorArea = document.getElementById('editor-area');
    const previewArea = document.getElementById('blog-preview-area');
    let editorInstance = null;

    function switchToEdit() {
        tabEdit.classList.add('active');
        tabPreview.classList.remove('active');
        editorArea.style.display = '';
        previewArea.style.display = 'none';
    }
    function switchToPreview() {
        tabPreview.classList.add('active');
        tabEdit.classList.remove('active');
        editorArea.style.display = 'none';
        previewArea.style.display = '';
        if (editorInstance) {
            previewArea.innerHTML = editorInstance.getData();
        }
    }
    tabEdit.onclick = switchToEdit;
    tabPreview.onclick = switchToPreview;

    // 初始化CKEditor 5
    ClassicEditor.create(document.querySelector('#blog-content-textarea'), {
        toolbar: {
            items: [
                'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'insertTable', 'imageUpload', 'imageInsert', 'undo', 'redo'
            ]
        },
        language: 'zh-cn',
    }).then(editor => {
        editorInstance = editor;
    });

    // 封面图预览
    function previewCover(input) {
        const file = input.files[0];
        const preview = document.getElementById('cover-preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        } else {
            preview.src = '#';
            preview.style.display = 'none';
        }
    }
    // 保存草稿按钮逻辑
    const saveDraftBtn = document.getElementById('blog-save-draft-btn');
    if (saveDraftBtn) {
        saveDraftBtn.onclick = function (e) {
            e.preventDefault();
            const form = this.closest('form');
            let input = form.querySelector('input[name="is_draft"]');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'is_draft';
                input.value = '1';
                form.appendChild(input);
            }
            form.submit();
        }
    }
</script>
{% endblock %}